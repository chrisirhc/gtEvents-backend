<?xml version="1.0"?>
<table xmlns="http://query.yahooapis.com/v1/schema/table.xsd">
  <meta>
    <sampleQuery>select * from {table} where expression = "(.*)" and text = "The quick brown fox leaps over the lazy dog";</sampleQuery>
    <description>This is a hacked out table. This should output the public events list from JacketPages.</description>
  </meta>
  <bindings>
    <select produces="XML" itemPath="">
      <urls>
        <url></url>
      </urls>
      <inputs>
        <key id="eventId" type="xs:string" paramType="variable" />
        <key id="startDate" type="xs:string" paramType="variable" />
      </inputs>
      <execute><![CDATA[
      default xml namespace = '';

      String.prototype.trim = function () {
        var str = this.replace(/^\s\s*/, ''),
        ws = /\s/,
        i = str.length;
        while (ws.test(str.charAt(--i)));
        return str.slice(0, i + 1);
      }

      // TODO can probably have different forums as an option
      /**
       * Return a list of eventIds
       */
      function getEvents() {
        var q;
        // this is to grab all the threads in the forum from the server
        q = y.query('use "http://chrisirhc.github.com/gtEvents-backend/jacketpages.eventslist.xml"; select * from jacketpages.eventslist' + (startDate ? (" where startDate='" + startDate + "'") : ""));
        return q.results.events.event;
      }

      /**
       * Return the event
       */
      function getEvent(eventId) {
        var t = <event id={eventId}/>;
        var q, tempq;

        var aevent;
        var aname, apic, apic_big, aall_time, astart_time, aend_time, ahost, adescription, alocation;

        q =
          y.query('select * from html where url="http://jacketpages.gatech.edu/events/details/'
          + eventId +
          '" and xpath="//div[@id=\'mainColumn\']";')
          .results;

        atitle = q.div.h2.em.toString();
        tempq = q.div.div.div.div.div.div;
        if (tempq.(@id == "event-image").length()) {
          apic = "http://jacketpages.gatech.edu" + tempq.(@id == "event-image")..img.@src.toString();
          apic_big = "http://jacketpages.gatech.edu" + tempq.(@id == "event-image").a[0].@href.toString();
        } else {
          apic = apic_big = '';
        }
        // Separate later
        aall_time = tempq.(@id == "event-info").div[0].p.toString().split(" to ");
        astart_time = aall_time[0];
        aend_time = aall_time[1];
        alocation = tempq.(@id == "event-info").div[1].p.toString();
        ahost = tempq.(@id == "event-info").div[2].a.toString();
        adescription = q.div.div.div.div.p.text().toString();

        t = <event id={eventId} title={atitle} pic={apic} pic_big={apic_big} start_time={astart_time} end_time={aend_time} location={alocation} host={ahost} >{adescription}</event>;
        return t;
      }

      // Get a list of events and get details of each
      var event;
      var events;
      if (eventId) {
        events = <event id={eventId} />;
      } else {
        events = getEvents();
      }
      response.object = <events/>;
      for each (var eid in events.@['id']) {
        response.object.events += getEvent(eid);
      }
	 ]]></execute>
    </select>
  </bindings>
</table>

