<?xml version="1.0"?>
<table xmlns="http://query.yahooapis.com/v1/schema/table.xsd">
  <meta>
    <sampleQuery>select * from {table} where expression = "(.*)" and text = "The quick brown fox leaps over the lazy dog";</sampleQuery>
    <description>This is a hacked out table. This should output the public events list from JacketPages.</description>
  </meta>
  <bindings>
    <select produces="XML" itemPath="">
      <urls>
        <url></url>
      </urls>
      <inputs>
        <key id="eventId" type="xs:string" paramType="variable" />
        <key id="startDate" type="xs:string" paramType="variable" />
      </inputs>
      <execute><![CDATA[
      default xml namespace = '';

      String.prototype.trim = function () {
        var str = this.replace(/^\s\s*/, ''),
        ws = /\s/,
        i = str.length;
        while (ws.test(str.charAt(--i)));
        return str.slice(0, i + 1);
      }

      // TODO can probably have different forums as an option
      /**
       * Return a list of threadIds for a particular forum (Photoshop Windows)
       */
      function getEvents() {
        var q;
        // this is to grab all the threads in the forum from the server
        q = y.query('use "http://chrisirhc.github.com/gtEvents-backend/jacketpages.eventslist.xml"; select * from jacketpages.eventslist('+ startDate +'); ');
        return q.results.events;
      }

      /**
       * Return a list of posts in the threadId given
       */
      function getEvent(eventId) {
        var months = {"January" : "01", "February" : "02", "March" : "03", "April" : "04", "May" : "05", "June" : "06", 
        "July" : "07", "August" : "08", "September" : "09", "October" : "10", "November" : "11", "December" : "12"};

        var t = <event id={eventId}/>;
        var q;

        var aevent;
        var atitle, abody, aauthor, aauthorid, atimestamp, apostid, areplyto;

        q =
          y.query('select * from html where url="http://jacketpages.gatech.edu/organization/womensrecruitmentteam/calendar/details/'
          + eventId +
          '" and xpath="//div[@id=\'mainColumn\']";')
          // a complex query for reference : '" and xpath="//table[@id=\'ctl01_ContentPlaceHolder1_MessageList_TopPanel\']/tr/td/p/text() | //table[@class=\'maintable\' and position() >= 2]/tr/td[position() = 1]/span[@class=\'titlehead\'] | //table[@class=\'maintable\' and position() >= 2]/tr/td[position() = 2]/div";')
          .results;

        y.log(q);


        // http://jacketpages.gatech.edu/events/details/53498
        /** Process a requested page **/
            /** 
            - February 7, 7:00 AM to 5:00 PM
            AM
            **/
            // "m-d-Y h:i A"
            // remapped to YY MM DD 't' hh II SS
            /* Previous method to reformat time (to use as reference)
            var regextime = /^-\s+(\w+)\s+([0-9]{2}),\s+([0-9]{2})\s+([0-9]{1,2}):([0-9]{2})\s+(A|P)/;
            atimestamp = atimestamp
              .match(regextime);
            if(atimestamp != null) {
              if(atimestamp[6] == "P" && atimestamp[4] != "12") {
                atimestamp[4] = parseInt(atimestamp[4], 10) + 12;
              } else if(atimestamp[6] == "A" && atimestamp[4] == "12") {
                atimestamp[4] = "00";
                // pad single digit
              } else if(atimestamp[4] < 10) {
                atimestamp[4] = "0" + atimestamp[4];
              }
              atimestamp = "20" + atimestamp[3] + months[atimestamp[1]] + atimestamp[2] + "T" + atimestamp[4] + atimestamp[5];
            }
             */

            t = <event timestamp={atimestamp} id={apostid} author={aauthor} authorid={aauthorid} title={atitle} threadid={"S" + threadId} postno={apostno} >{abody}</event>;
        return t;
      }

      // Get a list of events and get details of each
      var event;
      var events;
      if (eventId) {
        threads = <event id={eventId} />;
      } else {
        threads = getEvents();
      }
      response.object = <events/>;
      for each (var eid in events.@['id']) {
        response.object.events += getEvent(eid);
      }
	 ]]></execute>
    </select>
  </bindings>
</table>

